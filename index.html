<!doctype html>
<html lang="en">

<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
  <meta name="viewport" content="width=device-width, height=device-height" />
  <title>TODO // todo</title>
  <style type="text/css">
    body,
    input,
    button {
      font-size: 18pt;
    }

    h1 {
      margin: 0;
    }

    input {
      border-bottom-width: 1px;
      border-top-width: 1px;
      padding-bottom: 1px;
      padding-top: 1px;
    }

    #todo-name,
    #todo-list li {
      text-transform: capitalize;
    }

    ul {
      margin-top: 3px;
      padding-left: 0;
    }

    ul li {
      list-style: none;
      padding: 5px;
    }

    ul li:nth-child(odd) {
      background-color: gainsboro;
    }

    .deleteCandidate, .deleteCandidate hr {
      color: red;
      text-decoration: line-through;
    }

    ul li .internal-identifier {
      color: #acaaaa;
    }

    input[type=checkbox] {
      margin-right: 14px;
      transform: scale(2);
    }

    .divider input[type=checkbox] {
      float: left;
    }
  </style>
</head>

<body>
  <h1>// TODO</h1>

  <form id="todo-form" action="javascript:void(false);">
    <div>
      <input type="text" id="todo-name" autocomplete="off" placeholder="Milk"/><input type="submit" value="+" />
    </div>
  </form>

  <div>
    <a id="sync-link-container" target="_blank" title="Send this link to another device"></a>
    &middot;
    <a href="./about.html">About</a>
  </div>

  <ul id="todo-list">
  </ul>
  <script type="text/javascript">

    // Init service worker
    // Doesn't work w/o HTTPS
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/cache.js', { scope: '/' })
        .then(function (reg) {
          console.log('Registration succeeded. Scope is ' + reg.scope);
        }).catch(function (error) {
          console.log('Registration failed with ' + error, error);
        });
    }

    if (!window.indexedDB) {
      console.log("No IndexedDB");
      throw "No IndexedDB";
    } else {
      console.log("IndexedDB Available");
    }

    let request = window.indexedDB.open("TodoDb", 2);
    let db;

    request.onerror = function (event) {
      console.log("Error opening DB", event);
    };

    request.onupgradeneeded = function (event) {
      console.log("Upgrading db");
      const db = event.target.result;
      const objectStore = db.createObjectStore("item", { keyPath: "id", autoIncrement: true });
    };

    request.onsuccess = function (event) {
      db = event.target.result;

      db.onerror = function (event) {
        alert("Database error: " + event.target.errorCode, event);
      };

      const transaction = db.transaction(["item"], "readwrite");
      objectStore = transaction.objectStore("item");
      const item = "Item #" + Math.random().toString(36).substring(7);

      // GET ALL
      const readItems = db.transaction(["item"], "readonly").objectStore("item");
      readItems.getAll().onsuccess = function (event) {
        event.target.result.forEach(function (item) {
          handleAddEvent({
            item: {
              id: item.id,
              name: item.name
            }
          });
        });
      };

      // Handling Syncing
      if (window.location.hash) {
        const syncList = JSON.parse(atob(window.location.hash.substr(1))).map(item => item.name);
        const proceedWithSync = confirm("Request to sync the following:\n\n"
          + syncList.map(item => "\t* " + item).join("\n")
          + "\n\nProceed?");

        if (proceedWithSync) {
          syncList.forEach(function (itemName) {
            addItem(itemName);
          });
        }

        window.location.hash = "";
      }
    };

    // ADD
    document.getElementById("todo-form").addEventListener("submit", function (event) {
      event.preventDefault();
      addItem(document.getElementById("todo-name").value);
    }, false);

    // DELETE
    document.getElementById("todo-list").addEventListener("click", function (event) {
      if (event.target.type === "checkbox") {
        if (event.target.checked) {
          removeItem(event.target.parentElement, event.target.parentElement.todoId);
        } else {
          cancelRemoveItem(event.target.parentElement, event.target.parentElement.todoId);
        }
      }
    });

    function generateSyncUrlAndInjectToDom() {
      db.transaction(["item"], "readonly").objectStore("item").getAll().onsuccess = function (event) {
        const encodedSyncString = btoa(JSON.stringify(event.target.result.map(item => { return { name: item.name } })));
        const encodedSyncStringSize = (new TextEncoder('utf-8').encode(encodedSyncString)).length;
        const a = document.getElementById("sync-link-container");
        a.innerText = `Sync to device (${encodedSyncStringSize}b) \u29C9`;
        a.href = "#" + encodedSyncString;
      };
    }

    // Event Wiring
    const itemAddedBroadcastChannel = new BroadcastChannel('todo-broadcast');
    itemAddedBroadcastChannel.onmessage = function (event) {
      handleAddEvent(event.data);
    };
    const prepareItemRemovedBroadcastChannel = new BroadcastChannel('PrepareItemRemoved');
    prepareItemRemovedBroadcastChannel.onmessage = function (event) {
      handlePrepareItemRemovedEvent(document.getElementById("item-" + event.data.item.id));
    };
    const prepareCancelItemRemovedBroadcastChannel = new BroadcastChannel('CancelPrepareItemRemoved');
    prepareCancelItemRemovedBroadcastChannel.onmessage = function (event) {
      handleCancelPrepareItemRemovedEvent(document.getElementById("item-" + event.data.item.id));
    };
    const itemRemovedBroadcastChannel = new BroadcastChannel('ItemRemoved');
    itemRemovedBroadcastChannel.onmessage = function (event) {
      handleItemRemovedEvent(document.getElementById("item-" + event.data.item.id));
    };

    document.addEventListener("ItemAdded", function (event) {
      handleAddEvent(event.detail);
    });
    document.addEventListener("PrepareItemRemoved", function (event) {
      handlePrepareItemRemovedEvent(document.getElementById("item-" + event.detail.item.id));
    });
    document.addEventListener("CancelPrepareItemRemoved", function (event) {
      handleCancelPrepareItemRemovedEvent(document.getElementById("item-" + event.detail.item.id));
    });
    document.addEventListener("ItemRemoved", function (event) {
      handleItemRemovedEvent(document.getElementById("item-" + event.detail.item.id));
    });

    const emitItemAddedEvent = function (itemEvent) {
      itemAddedBroadcastChannel.postMessage(itemEvent);
      document.dispatchEvent(new CustomEvent("ItemAdded", {detail: itemEvent}));
    };
    const emitPrepareItemRemovedEvent = function (todoId) {
      prepareItemRemovedBroadcastChannel.postMessage({item: {id: todoId}});
      document.dispatchEvent(new CustomEvent("PrepareItemRemoved", {detail: {item: {id: todoId}}}));
    };
    const emitCancelPrepareItemRemovedEvent = function (todoId) {
      prepareCancelItemRemovedBroadcastChannel.postMessage({item: {id: todoId}});
      document.dispatchEvent(new CustomEvent("CancelPrepareItemRemoved", {detail: {item: {id: todoId}}}));
    };
    const emitItemRemovedEvent = function (todoId) {
      itemRemovedBroadcastChannel.postMessage({item: {id: todoId}});
      document.dispatchEvent(new CustomEvent("ItemRemoved", {detail: {item: {id: todoId}}}));
    };
    // End Event Wiring

    const handleAddEvent = function (itemEvent) {
      const li = document.createElement("li");

      const checkBox = document.createElement("input");
      checkBox.setAttribute("type", "checkbox")
      li.appendChild(checkBox);

      if (itemEvent.item.name) {
        li.appendChild(document.createTextNode(`${itemEvent.item.name} `));
        const span = document.createElement("span");
        span.appendChild(document.createTextNode(`[${itemEvent.item.id}]`));
        span.classList.add("internal-identifier");
        li.appendChild(span);
      } else {
        li.classList.add("divider");
        li.appendChild(document.createElement("hr"));
      }
      li.todoId = itemEvent.item.id;
      li.id = "item-" + itemEvent.item.id;

      document.getElementById("todo-list").insertBefore(li, document.getElementById("todo-list").firstChild);
      document.getElementById("todo-name").value = "";

      generateSyncUrlAndInjectToDom();
    };

    const handlePrepareItemRemovedEvent = function (el) {
      el.classList.add("deleteCandidate");
    };

    const handleCancelPrepareItemRemovedEvent = function (el) {
      el.classList.remove("deleteCandidate");
    };

    const handleItemRemovedEvent = function (el) {
      el.remove();
      generateSyncUrlAndInjectToDom();
    };

    const addItem = function (itemName) {
      db.transaction(["item"], "readwrite").objectStore("item").add({ name: itemName }).onsuccess = function (event) {
        event.target.transaction.objectStore("item").get(event.target.result).onsuccess = function (event) {
          emitItemAddedEvent({
            item: {
              id: event.target.result.id,
              name: event.target.result.name
            }
          });
        };
      };
    };

    const timeoutIdByTodoIdMap = new Map();

    const removeItem = function (el, todoId) {
      emitPrepareItemRemovedEvent(todoId);

      timeoutIdByTodoIdMap.set(
              todoId,
              setTimeout(function () {
                db.transaction(["item"], "readwrite").objectStore("item").delete(todoId).onsuccess = function (event) {
                  emitItemRemovedEvent(todoId);
                };
              }, 10 * 1000, db, el)
      );
    };

    const cancelRemoveItem = function (el, todoId) {
      emitCancelPrepareItemRemovedEvent(todoId);

      if (timeoutIdByTodoIdMap.has(todoId)) {
        clearTimeout(timeoutIdByTodoIdMap.get(todoId));
      }
    };
  </script>
</body>

</html>
